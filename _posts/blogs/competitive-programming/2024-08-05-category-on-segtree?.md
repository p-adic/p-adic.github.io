---
layout: blog
title: セグメント木に圏が乗るという言説について
date: 2024-08-05
excerpt: "セグメント木に圏が乗るという言説について書いていきます。"
parent: competitive-programming-blog/
prev-child: how-to-create-problems-for-competitive-programming
next-child: 
blog: true
tags: [競技プログラミング]
---


## 趣旨

競技プログラミングではセグメント木と呼ばれるデータ構造（数列などの要素の管理方法を工夫することで様々な処理を高速に実現できるようにしたもの）が使われます。セグメント木は数列より広く、モノイドという代数構造が乗る（つまりモノイドに値を持つ配列を管理できる）のですが、圏はモノイドを更に一般化した概念です。それではセグメント木と圏にはどのような関係があるでしょう？

どうも出典[1]の$\S$ 6.3に「モノイドや半群と比べて, 圏はセグメント木と関連する構造をより過不足なく捉えられていると言える.」と述べられていることを踏まえてなのか「セグメント木にはモノイドより広く圏が乗る」的な言説を述べることがあります。しかし[1]の元々の主張は恐らくあくまで厳密な意味を知っている人向けの標語的なものに過ぎず、圏そのものはモノイドと同様に「無条件には」乗りません。

この記事では[1]の正確な意味を説明するとともに、セグメント木の基本的な知識を持っている競技プログラマー向けに何故「セグメント木には圏が乗る」という言説が文字通りには誤りであるかを説明します。

ただしセグメント木についてはほとんど素botであるため、何か間違えているかもしれません。その場合はご一報くださいますと幸いです。


## 結論

結論から言うと、「セグメント木に乗るのは区間から圏への関手」という表現がより正確です。

そのことを説明するために、そもそも「モノイドが乗る」とはどういう意味かに戻って説明する必要があります。

なお、上で述べている圏とは小圏のことです。小圏（small category）は圏の中でも特別なものなのですが、小圏のみを指す文脈でも圏（category）と呼ぶ慣習がある（その場合は小圏でない圏をbig ctaegoryと呼ぶ）ためにそのようにしています。

例えば競技プログラミングでもおなじみの[種の理論](https://en.wikipedia.org/wiki/Combinatorial_species)では小圏でない圏$\textrn{FSet}$を使います。他にも競技プログラミングでおなじみの[マトロイド](https://ja.wikipedia.org/wiki/%E3%83%9E%E3%83%88%E3%83%AD%E3%82%A4%E3%83%89)と関係の深い[単体的集合](https://en.wikipedia.org/wiki/Simplicial_set)は、小圏$\Delta$から小圏でない圏$\textrm{Set}$への反変関手を使います。

とはいえせっかくなので以下ではきちんと圏と小圏を区別して説明します。


## 小圏の定義

小圏にはいくつかの等価な定義があるのですが、ここでは競技プログラマーに分かりやすいと思われる定式化の１つを説明します。

小圏とは、以下のデータの組み合わせ$(M,s,t,\circ)$に後述する要件を課したものです。

1. 集合$M$
1. $2$つの写像 $s,t \colon M \to M$
1. 写像$\circ \colon M^{[2]} \to M$（ただしここで$M^{[2]} := \{(m_0,m_1) \in M^2 \mid s(m_0) = t(m_1)\}$と置いた）

$M$の要素を射と呼び、写像$\circ$を合成と呼びます。ただし$M^{[2]}$は$M^2$より小さくなり得るので、合成は$M^2$全体で定義されるとは限りません。

$s$の像$\{s(m) \mid m \in M\}$を$V$と置き、$M \setminus V$を$E$と置きます。小圏に課される要件は以下の4つです。

1. $t$の像$\{t(m) \mid m \in M\}$は$V$と等しい。
1. いかなる$v \in V$に対しても$s(v) = v = t(v)$である。
1. いかなる$(m_0,m_1) \in M^{[2]}$に対しても$s(m_0 \circ m_1) = s(m_1)$かつ$t(m_0 \circ m_1) = t(m_0)$である。
1. （単位律）いかなる$m \in M$に対しても$m \circ s(m) = m = t(m) \circ m$である。
1. （結合律）いかなる$(m_0,m_1,m_2) \in M^{[3]}$に対しても$m_0 \circ (m_1 \circ m_2) = (m_0 \circ m_1) \circ m_2$である。（ただしここで$M^{[3]} := \{(m_0,m_1,m_2) \in M^2 \mid s(m_0) = t(m_1) \land s(m_1) \in t(m_2)\}$と置いた）

これだけではあまりイメージがつきにくいと思うので、代数的な説明と幾何的な説明をします。


### 代数的な説明

代数が得意な人向けにイメージを説明します。$M$は$2$項演算のようなものが定義されているのですが、普通の$2$項演算と違って定義域に制限があります。

各$m \in E$ごとに$t(m)$と$s(m)$が$m$にとっての左単位元と右単位元のような機能を持ちます。特に$s(m)  = t(m)$となる時はこれが単位元の役割を持ちます。

普通のマグマであれば単位元は一意ですが、$2$項演算の定義域に制限があるため単位元はまるで一意ではなく、$V$が単位元全体の集合となります。

$V$の要素$v$を１つ固定するごとに、$v$を単位元に持つモノイドが$M$の部分集合として排他的に取れ、それらを集めると$s(m) = t(m)$を満たす$m \in M$全体の集合となります。

それらのモノイドの間にも属さない要素たち（$s(m) \neq t(m)$となる$m \in M$たち）がまだまだ存在するかもしれず、それらがモノイドたちを結んで様々な性質が現れます。


### 幾何的な説明

グラフ理論が得意な人向けにイメージを説明します。$V$を頂点集合として$E$を辺集合とする有向グラフを考えましょう。具体的には各$m \in E$が$s(m)$から$t(m)$へ至る有向辺とみなせば良いです。

この有向グラフは多重辺を持ち得ますが、自己ループを持ちません。むしろ各$v \in V$が自己ループのようなもので、それらを除くことで自己ループがなくなっていると考えても良いです。

有向辺には合成のような演算が定義されています。つまり、有向辺$m_0$と$m_1$が逆順に（$m_1$を通ってから$m_0$を通る順に）結合できる場合にのみ、結合結果と同じ頂点を結ぶ有向辺が$m_0 \circ m_1$が定義されます。

これだけだと色々な解釈がありえて、例えば演算を「$2$つの有向辺$m_0$と$m_1$を逆順に続けて通る代わりに別の特定の有向辺$m_0 \circ m_1$を通って良い」という経路の簡約化に関するルールの集まりだと思ってもよいです。


## モノイドとの関係

小圏の例はモノイドで与えられます。具体的には、モノイド$M$の下部構造としての集合もまた$M$と書き表すことにして、$M$の単位元$e$に値を取る定数写像$M \to M, m \mapsto e$を$c$と置いて、$M$の演算を$\circ$と置くと、$(M,c,c,\circ)$が小圏となります。この小圏は$V = \{e\}$を満たします。

ところで小圏にも群やモノイドと同様に同型という概念があります。一般に与えられた小圏$(M,s,t,\circ)$が追加の条件$\# V = 1$を満たす時は上の方法でモノイドから作る小圏と同型になります。そのため、$\# V = 1$を満たす小圏のこともモノイドと呼びます。

この意味で、小圏は確かにモノイドの一般化とみなすことができます。


## 小圏の例

モノイド以外に競技プログラミングで現れるかもしれない小圏の例を紹介します。


### 写像の小圏

$V$を集合族とし、各$(v_0,v_1) \in V$に対し$\textrm{Hom}(v_0,v_1)$で写像$v_0 \to v_1$全体の集合を表すとします。

$(v_0,v_1) \in V$をわたる$\textrm{Hom}(v_0,v_1)$の排他的和集合を$M$と置きます。

この時各$v \in V$に対し恒等写像$\id_v \colon v \to v$を対応させることで単射$V \hookrightarrow M$が得られ、$V$をこの像と同一視します（つまり像もまた記号を濫用して$V$と書きます）。

各$m \in M$は$V$の要素を定義域と終域に持つ写像なので、定義域を取り出す写像$s \colon M \to V \subset M$と終域を取り出す写像$t \colon M \to V \subset M$が定まります。

すると組$(M,s,t,\circ)$は小圏をなします。ここで$\circ$は写像を合成する演算です。


### 線形写像の小圏

$K$を体とし、$V$を$K$線形空間の族とし、各$(v_0,v_1) \in V$に対し$\textrm{Hom}_K(v_0,v_1)$で$K$線形写像$v_0 \to v_1$全体の集合を表すとします。

$(v_0,v_1) \in V$をわたる$\textrm{Hom}_K(v_0,v_1)$の排他的和集合を$M$と置きます。

この時各$v \in V$に対し恒等写像$\id_v \colon v \to v$を対応させることで単射$V \hookrightarrow M$が得られ、$V$をこの像と同一視します（つまり像もまた記号を濫用して$V$と書きます）。

各$m \in M$は$V$の要素を定義域と終域に持つ線形写像なので、定義域を取り出す写像$s \colon M \to V \subset M$と終域を取り出す写像$t \colon M \to V \subset M$が定まります。

すると組$(M,s,t,\circ)$は小圏をなします。ここで$\circ$は線形写像を合成する演算です。


### 半順序集合

$(V,E)$が（狭義）半順序集合であるとは、$E$が$V^2$の部分集合であって以下を満たすということです

1. （非反射律）いかなる$v \in V$に対しても、$v E v$でない。
1. （反対称律）いかなる$(v_0,v_1) \in V^2$に対しても、$v_0 E v_1$でないまたは$v_1 E v_0$でない。
1. （推移律）いかなる$(v_0,v_1,v_2) \in V^3$に対しても$v_0 E v_1$かつ$v_1 E v_2$ならば$v_0 E v_2$である。

ただしここで、$(v_0,v_1) \in V^2$に対する$v_0 E v_1$は$(v_0,v_1) \in E$の略記です。この記法により結果的に$E$は$v_0 E v_1$を満たす$(v_0,v_1) \in V^2$全体の集合と一致するため$E$をこの半順序集合のグラフとも呼びます。

例えば集合$S$が与えられている時、$V$を$S$の部分集合全体の集合として、$E$を真部分集合関係とすると、$(V,E)$は半順序となります。

$(V,E)$を半順序集合とします。$V$と$E$の排他的和集合を$M$と置き、恒等写像$V \to V$と第$1$成分を取り出す写像$E \to V$の合併$M \to V \subset M$を$s$と置き、恒等写像$V \to V$と第$2$成分を取り出す写像$E \to V$の合併$M \to V \subset M$を$t$と置き、写像$M^{[2]} \to M, \ (m_0,m_1) \mapsto (s(m_1),t(m_0))$を$\circ$と置きます。

ここで$M^{[2]}$は$s$と$t$から定めたもので、その要素は$s(m_0) = t(m_1)$を満たす$(m_0,m_1) \in E^2$であり、$(m_0,m_1) = ((s(m_0),t(m_0)),(s(m_1),t(m_1))$と表せることに注意しましょう。つまり$\circ$は$s(m_0) = t(m_1)$部分を消して新たな組を作るもので、推移律そのものを体現する演算です。

すると$(M,s,t,\circ)$は小圏をなします。そしてこの小圏は有向グラフとして多重辺を持ちません。

一般に与えられた小圏$(M,s,t,\circ)$が追加の条件「有向グラフとして多重辺を持たない」を満たす時は上の方法で半順序集合から作る小圏と同型になります。そのため、条件「有向グラフとして多重辺を持たない」を満たす小圏のことも半順序集合と呼びます。

この意味で、小圏は半順序集合の一般化とみなすことができます。


## セグメント木に小圏が乗らないこと

そもそもセグメント木にモノイドが乗るとは、セグメント木によってモノイドの要素からなる任意の固定長配列が管理できる（それにより総和が高速に計算できる）ということです。

同じ要領でセグメント木に小圏が乗るでしょうか？　モノイドと小圏の関係を考えると、セグメント木に小圏が乗るとは、セグメント木によって小圏の射からなる任意の固定長配列が管理できる（それにより合成が高速に計算できる）ということです。

しかしながらセグメント木はその特性上、配列で隣り合う成分同士に合成が定義されなければ機能しません。

従ってセグメント木にモノイドが乗ることと同じ要領ではセグメント木に小圏が乗らないわけです。

ただしmaspyさんはそれでも「[モノイドがのるとされる文脈の一般化であれば（適切な）圏がのるという表現でよいです](https://twitter.com/maspy_stars/status/1820451569248403527)」と述べているため、もしかしたら上級者には有名な手法であって配列で隣り合う成分同士に合成が定義されなくても構造を変更したりせずセグメント木を機能させる方法があるのかもしれません。

ただその前に[関手がセグメント木に乗ることを誤りと疑っているように読める文を述べていらしたり何故か合成が関手でないことを気にしていらしたりしていた](https://twitter.com/maspy_stars/status/1819817578069737884)ので、単に圏と関手周りの正確な扱いをご存知でなかっただけかもしれません。念のために[こちら](https://twitter.com/non_archimedean/status/1819987461432570005)と[こちら](https://twitter.com/non_archimedean/status/1820459861274239339)で真意をお伺いしておきましたが現在のところ特にご返答はございません。


## セグメント木に実際に乗るもの

上で見たように、「セグメント木にモノイドが乗る」という表現をするときの「モノイド」部分を直接広い代数構造に置き換えることはできません。

同様に「セグメント木にモノイドの要素からなる任意の固定長の配列が乗る」という表現をするときの「モノイド」部分を直接広い代数構造に置き換えることはできません。

一方で「モノイドの要素からなる任意の固定長の配列が乗る」部分を「小圏の射からなる任意の固定長配列であって隣接成分が合成可能なもの」に置き換えることは正しいです。

標語的に縮めて初学者に誤解を広めてしまうことを避けるには、そのような正確な表現をすべきでしょう。

とはいえこれは長いです。もう少し短く表現できないものでしょうか？　そこで役立つのが「区間からの関手」です。

$N$を非負整数として、全順序集合$\mathbb{Z} \cap [0,N)$は狭義プログラミングの文脈ではしばしば$[0,N)$と略記され区間という用語が濫用されます。

全順序集合は半順序集合の特別なものなので小圏をなすわけなので区間も小圏です。

また群にとっての群準同型やモノイドにとってのモノイド準同型と同様、小圏にも準同型の概念が定義されて関手と呼ばれています。

小圏がモノイドの一般化であったことと整合的な見方で、関手はモノイド準同型の一般化となります。

一般の関手の定義はさておき、小圏$(M,s,t,\circ)$が与えられた時に区間$[0,N)$から$(M,s,t,\circ)$への関手を与えることと、$M$の射からなる長さ$N$の配列であって隣接する成分がその順に合成可能なものを与えることは等価です。

以上より、セグメント木に実際に乗るものは小圏そのものではなく、区間から小圏への関手です。もちろん区間から小圏への関手やそれと等価なものが乗ることを指して「圏が乗る」と表現している人が多いのかもしれませんが、「モノイドが乗る」という表現の意味を考えると「小圏が乗る」より「区間から小圏への関手が乗る」がより正確な表現となる、ということです。

文字通りに受け取ると誤りな標語は初学者を誤解させやすいので、なるべく正確な表現を心掛けていきたいものですね。


## 遅延評価

ところで皆さんは、「セグメント木で作用の遅延評価ができるのはどういう時か？」と問われたらどう答えますか？

そもそもモノイドを乗せた場合にすらギリギリを攻めた条件が競技プログラミング界隈ではあまり有名ではなさそうです。

というのもAtCoder Libraryのドキュメントをはじめとする遅延セグメント木の解説ではかなり緩めの十分条件が与えられているだけだからです。

例えば「基点付きマグマからモノイドへの作用であって基点を恒等写像に移すものが与えられた時」レベルでギリギリまで攻めている解説を読んだことがありません。

ではモノイドの要素からなる固定長の配列を一般化して、区間から小圏$C$への関手を乗せた場合はどうでしょう？

なおさら競技プログラミング界隈では有名じゃないだろうと予想します。

答えは「基点付きマグマから$C$への作用であって単位元を恒等関手に写すもの」で良いです。

ここは単にモノイドを小圏に、写像を関手に変えるだけで良いわけですね。

ただしこの設定だと関手が対象を保つ（有向グラフに翻訳した時の$V$に恒等写像を定める）とは限らないことに注意しましょう。

つまり例えばセグメント木に区間から線形写像の圏への関手を乗せる場合、作用によって各ベクトル空間の次元すら変わりうる（コンパイル時に固定できない）ものすら許容されるということです。


## Maybeモナド

ところで集合$M$と$M^2$の部分集合$D$と写像$\circ \colon D \to M$が与えられた時、実装上は$\circ$を$M^2$全体で定義されているものとして扱いたいことが多々あります。

そこで役に立つのがMaybeモナドの考え方で、$M$に属さない項$x$を１個$M$に追加したものを$M_+$と置き、新たな写像$\circ_+ \colon M_+^2 \to M_+$を

\\[
m_0 \circ_+ m_1 := 
\left\\{
\begin{array}{ll}
m_0 \circ m_1 & ((m_0,m_1) \in D) \\\\
x & ((m_0,m_1) \notin D)
\right.
\\]

と定めることで$(M,\circ)$を拡張してマグマ$(M_+,\circ_+)$を得ることができます。例えば小圏に対しこの方法で得られるマグマは$x$を[吸収元](https://ja.wikipedia.org/wiki/吸収元)とするモノイドとなるので、このままセグメント木に乗せることができることが知られています<sup>[2]</sup>。

ただしこの方法で吸収元つきモノイドに翻訳した場合、遅延評価で混乱しないように注意する必要があります。

というのも、区間から小圏への関手を乗せた場合の遅延評価は、吸収元つきモノイドを乗せた場合の遅延評価と要件が異なるからです。

後者は基点つきマグマからモノイドへの作用であって基点を恒等写像に写すものが全て許されますが、前者に対応するものは追加の条件として「$x$でない元を$x$に写さない」という強い制約が課されます。

吸収元を追加した分構造が大きくなるので、遅延評価の要件も同地でないものに変わってしまうというわけですね。


## その他のデータ構造

何もセグメント木が特別なわけではなく、平方分割でも区間から小圏への関手が乗ります。ただ平方分割はこれで限界というわけではなく、例えば集合$X$と自由アーベル群$\mathbb{Z}^{\oplus X}$の組を乗せる事ができます。

累積和も区間から亜群への関手を乗せられますね。可換性が必要なフェニック木には亜群だと困りますが、２本使えばモノイドが乗るので同じ要領で区間から小圏への関手も乗ると言っても許されそうです。



## 出典

1. Kimiyuki Onaka and Shiho Midorikawa, [セグメント木と代数構造の理論](https://elliptic-shiho.github.io/segtree/segtree.pdf), 2024-02-12.
2. tatyam (@tatyam_prime), ["計算不能" を集合に入れてしまえばモノイドになってしまうという話は，ある](https://twitter.com/tatyam_prime/status/1790626129017237552), twitter, 2024-05-15.

